<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ciarán O’Kelly">

<title>ML Disney Sentiments</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Disney ML Process_files/libs/clipboard/clipboard.min.js"></script>
<script src="Disney ML Process_files/libs/quarto-html/quarto.js"></script>
<script src="Disney ML Process_files/libs/quarto-html/popper.min.js"></script>
<script src="Disney ML Process_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Disney ML Process_files/libs/quarto-html/anchor.min.js"></script>
<link href="Disney ML Process_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Disney ML Process_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Disney ML Process_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Disney ML Process_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Disney ML Process_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ML Disney Sentiments</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ciarán O’Kelly </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Taking guidance from <a href="https://juliasilge.com/blog/animal-crossing/">Julia Silge</a> this exercise aims to use a machine learning algorithm to explore the words that are most salient in 1* and 5* ratings. We will filter for those ratings, train on the majority of the data and then test our results on the remainder.</p>
<p>That is, the algorithm will try to spot the difference between positive and negative ratings, then test on data where it hasn’t been told which ratings are positive and which ones are negative.</p>
<p>We use a <a href="https://www.statisticshowto.com/lasso-regression/">lasso regression</a> to perform this analysis and we also run variants on the analysis 25 times before choosing the most effective one in predicting which rating is 5* and which is 1*. In general, don’t try to understand the maths (it’s certainly at the outer edges of my capacities) but check out the ML workflow.</p>
<p>First let’s load the libraries we will use and the dataset.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/libraries_a6befee1803d4dbeda8b413bede3451c">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(textrecipes)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>disney <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"DisneylandReviews.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="explore-the-data" class="level1">
<h1>Explore the data</h1>
<p>Let’s look at some reviews, then count the number of reviews for each rating.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/look_at_reviews_1a1763b1a8c64dd0927d798a2978d6e6">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>disney <span class="sc">%&gt;%</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Rating <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> Rating <span class="sc">==</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sample_n</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(Review_Text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "We had a wonderful day at Disneyland, this was our first Disney experience so cannot offer any comparisons.The attention to detail in and on the way to the park is fantastic, the staff were all friendly and the stickers they give the children were a lovely touch. We were very impressed with the shows, especially the Lion King and the paint the night parade was excellent. Our son loved meeting the Star Wars characters. We spent a full day there and did most of what we wanted to. Another half day would have meant we covered everything."                                                                                                                                                                                                                                                                                                                     
[2] "Went there with my 8 year old kid. As soon as we reached this place his first statement was  papa I dont want to go back . Beautiful place with lots of interesting rides. Adults also enjoy like kids. At first the ticket price seemed to be quite high. But when you visit this place it seems that the price is quite cheap for what u experience.I lost my camera in the park. After few minutes i was in panic I started looking around for it. After an hour I reached their lost and found department and was glad to know they already had my camera. One of the staff members had found it and handed over to the office. Thanks very much for returning me back my memories packed in that camera.Do wait till end in the evening as the fire works show is beautiful.The special MTR is also very charming. I still cherish my memories of this place a lot."        
[3] "Visiting the 'happiest place on earth' was everything I'd hope it to be and more. Loved the parade and all the photo opportunities with the characters. Disneyland just brings out the child in everyone. There are queues for most of the rides but if you get a 'fast pass' you can go on other rides while you wait for your return time slot. Actually, there are queues for almost everything including most food outlets and the restrooms. The park is huge and involves lots of walking so I would definitely recommend wearing comfortable shoes and also take a jacket if your going in the fall winter as it can get cold in the evenings."                                                                                                                                                                                                                           
[4] "Absolutely amazing place, especially considering I wasn't too fussed about going originally and was bullied into it by the wife and kids!!We all absolutely loved it, even more so on the second day once we'd got our bearings. One recommendation would be to plan what you want to see and go on in advance, makes such a difference then blindly wandering round and joining random queues. Be prepared to queue for pretty much everything, especially the food   but they do serve it relatively quickly (we budgeted    20 per head, per meal and we weren't far off).The light show in the evening is well worth staying for (starts at 11pm) but the scrum for the bus back to the hotel after wasn't great   saw quite a few tempers getting fraught and when you have small kids it's not ideal...But on the whole, really, really impressed and will be going again."
[5] "My wife, infant daughter and I recently took in three days at the Disneyland parks. Had an amazing time, which is not hard to do since that is Disney's specialty. Though you pay a heavy price tag for that. I would definitely go back, even though we are more of a Walt Disney World family."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </code></pre>
</div>
</div>
<div class="cell" data-hash="Disney-ML-Process_cache/html/unnamed-chunk-4_5ec412d9e40496cc9a6282234da5f214">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>disney <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Rating =</span> <span class="fu">factor</span>(Rating)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(Rating) <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    count <span class="sc">%&gt;%</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(., <span class="fu">aes</span>(<span class="at">x =</span> Rating, <span class="at">y =</span> n, <span class="at">fill =</span> Rating)) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Disney-ML-Process_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that there are far more 5* ratings than there are any other ratings. This will have an impact on the reliability of our work below.</p>
</section>
<section id="prepare-the-dataset" class="level1">
<h1>Prepare the dataset</h1>
<p>For this exercise we are just going to try and predict which words are most salient for 1* and 5* ratings. Everything else is filtered out. Then mostly using the <a href="https://www.tidymodels.org/">tidymodels</a> and <a href="https://textrecipes.tidymodels.org/">text recipes</a> we will prepare the data. Note the tidymodels library often splits up your making the recipe from actually acting on the recipe…</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/unnamed-chunk-5_30d9f2869d9e479e6c4da66df4260a89">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#|label: split_dataset</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>disney_polarised <span class="ot">&lt;-</span> disney <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Rating <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> Rating <span class="sc">==</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">polar =</span> <span class="fu">case_when</span>(Rating <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Negative"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                             Rating <span class="sc">==</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">"Positive"</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">polar =</span> <span class="fu">factor</span>(polar))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we split between training and testing data. Note ‘set seed’ here: it is a process whereby the split is always the same rather than being random. It’s just best for reproducibility. In an actual process we would not do this.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/split_4b207e32830e419c545cd9ec7dce07b0">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>review_split <span class="ot">&lt;-</span> disney_polarised <span class="sc">%&gt;%</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">initial_split</span>(., <span class="at">strata =</span> polar)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>review_train <span class="ot">&lt;-</span> <span class="fu">training</span>(review_split)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>review_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(review_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we preprocess the dataset. Check out each step. You should be able to figure out what is happening given what we have done in class. <a href="https://recipes.tidymodels.org/reference/step_normalize.html">step_normalize</a> coerces the data into a normal distribution. Language data is never normally distributed but many ML processes needs it to be.</p>
<p>Now we create a workflow for performing the statistical analysis on the text data. This draws on the lasso algorithm in the <a href="#0">glmnet</a> library.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/lasso_workflow_4048fb5f9b218e1040e00b17f63702aa">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>lasso_spec <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>lasso_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(review_rec) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lasso_spec)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>lasso_wf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: logistic_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
5 Recipe Steps

• step_tokenize()
• step_stopwords()
• step_tokenfilter()
• step_tfidf()
• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────
Logistic Regression Model Specification (classification)

Main Arguments:
  penalty = tune()
  mixture = 1

Computational engine: glmnet </code></pre>
</div>
</div>
<p>Now we prepare a ‘tuning’ process whereby we will run the algorithm above 25 times in different ways, so we can see which is best. This is important with ‘unlabelled’ data. In fact the process below is very handy if you want to create, say, a dictionary of positive and negative words.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/prep_tune_c83bf4a6c85b7a1e7bb964d79afb9d53">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lambda_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(<span class="fu">penalty</span>(), <span class="at">levels =</span> <span class="dv">40</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>review_folds <span class="ot">&lt;-</span> <span class="fu">bootstraps</span>(review_train, <span class="at">strata =</span> polar)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>review_folds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Bootstrap sampling using stratification 
# A tibble: 25 × 2
   splits               id         
   &lt;list&gt;               &lt;chr&gt;      
 1 &lt;split [18483/6851]&gt; Bootstrap01
 2 &lt;split [18483/6797]&gt; Bootstrap02
 3 &lt;split [18483/6785]&gt; Bootstrap03
 4 &lt;split [18483/6810]&gt; Bootstrap04
 5 &lt;split [18483/6802]&gt; Bootstrap05
 6 &lt;split [18483/6815]&gt; Bootstrap06
 7 &lt;split [18483/6829]&gt; Bootstrap07
 8 &lt;split [18483/6788]&gt; Bootstrap08
 9 &lt;split [18483/6882]&gt; Bootstrap09
10 &lt;split [18483/6821]&gt; Bootstrap10
# ℹ 15 more rows</code></pre>
</div>
</div>
</section>
<section id="run-the-analysis." class="level1">
<h1>Run the analysis.</h1>
<p><strong>Be warned</strong>: this is <em>very</em> slow.</p>
<p>Now we run the analysis and collect the results.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/implement_tune_d720cf11d7e25a62cccf7652d32f3178">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>lasso_grid <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  lasso_wf,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> review_folds,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> lambda_grid,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(roc_auc, ppv, npv)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="Disney-ML-Process_cache/html/examine_results_a0dc36961188d01bac1dad98d73dd155">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>lasso_grid <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 120 × 7
    penalty .metric .estimator  mean     n  std_err .config              
      &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;                
 1 1   e-10 npv     binary     0.979    25 0.000365 Preprocessor1_Model01
 2 1   e-10 ppv     binary     0.539    25 0.00493  Preprocessor1_Model01
 3 1   e-10 roc_auc binary     0.935    25 0.00298  Preprocessor1_Model01
 4 1.80e-10 npv     binary     0.979    25 0.000365 Preprocessor1_Model02
 5 1.80e-10 ppv     binary     0.539    25 0.00493  Preprocessor1_Model02
 6 1.80e-10 roc_auc binary     0.935    25 0.00298  Preprocessor1_Model02
 7 3.26e-10 npv     binary     0.979    25 0.000365 Preprocessor1_Model03
 8 3.26e-10 ppv     binary     0.539    25 0.00493  Preprocessor1_Model03
 9 3.26e-10 roc_auc binary     0.935    25 0.00298  Preprocessor1_Model03
10 5.88e-10 npv     binary     0.979    25 0.000365 Preprocessor1_Model04
# ℹ 110 more rows</code></pre>
</div>
</div>
</section>
<section id="examining-the-analysis." class="level1">
<h1>Examining the analysis.</h1>
<p>The picture below tells us a bit about how well the analysis ran. The answer is, well on ‘area under the curve’ and on positive words, but less well on negative words. You can read up on AUC <a href="https://towardsdatascience.com/roc-analysis-and-the-auc-area-under-the-curve-404803b694b9">here</a> but in essence it’s a means of looking at ‘precision’ and ‘recall.’ That is, precision is the number of true positive results you got as a fraction of all the positive results your model declared. And recall is the ration of ‘true positives’ over all the actual positives (‘true positives’ plus ‘false negtives’).</p>
<p>A higher AUC is better, but a very high one might suggest that your model has ‘overfitted.’ That would mean your model might run very well on the training data but less well on any new data.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/viz_results_b3a3ae473b9f153ee251ff0821771044">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>lasso_grid <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(penalty, mean, <span class="at">color =</span> .metric)) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric) <span class="sc">+</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Disney-ML-Process_files/figure-html/viz_results-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can choose which is the best model from the 50 we ran with our ‘bootstrapping’ process.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/best_model_8a30dcb51cf42e65e7494be6fc4e1ef0">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>best_auc <span class="ot">&lt;-</span> lasso_grid <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="st">"roc_auc"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>best_auc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
   penalty .config              
     &lt;dbl&gt; &lt;chr&gt;                
1 0.000838 Preprocessor1_Model28</code></pre>
</div>
</div>
</section>
<section id="which-words-are-most-salient" class="level1">
<h1>Which words are most salient?</h1>
<p>Now let’s finalise our workflow based on our decision about which is the best model, fit it to the testing data and look at which words are best?</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/final_lasso_aa3e52f13ca6138124087f221647dfa7">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>final_lasso <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(lasso_wf, best_auc)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>final_lasso</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: logistic_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
5 Recipe Steps

• step_tokenize()
• step_stopwords()
• step_tokenfilter()
• step_tfidf()
• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────
Logistic Regression Model Specification (classification)

Main Arguments:
  penalty = 0.000837677640068291
  mixture = 1

Computational engine: glmnet </code></pre>
</div>
</div>
<div class="cell" data-hash="Disney-ML-Process_cache/html/visualise_lasso_6e824c5e9ccf03ac54193723a32c6ac4">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>final_lasso <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(review_train) <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vi</span>(<span class="at">lambda =</span> best_auc<span class="sc">$</span>penalty) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Sign) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">20</span>, <span class="at">wt =</span> <span class="fu">abs</span>(Importance)) <span class="sc">%&gt;%</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Importance =</span> <span class="fu">abs</span>(Importance),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> <span class="fu">str_remove</span>(Variable, <span class="st">"tfidf_Review_Text_"</span>),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> <span class="fu">fct_reorder</span>(Variable, Importance)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Importance, <span class="at">y =</span> Variable, <span class="at">fill =</span> Sign)) <span class="sc">+</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Sign, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Disney-ML-Process_files/figure-html/visualise_lasso-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="how-good-was-the-model" class="level1">
<h1>How good was the model</h1>
<p>We can also look at a ‘confusion matrix’ which will tell us how successful our model was at predicting 1* and 5* ratings from the words.</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/final_fit_b0457288a272b17aa9c8e0156d0c6c66">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>review_final <span class="ot">&lt;-</span> <span class="fu">last_fit</span>(final_lasso, review_split)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>review_final <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric  .estimator .estimate .config             
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy binary         0.969 Preprocessor1_Model1
2 roc_auc  binary         0.973 Preprocessor1_Model1</code></pre>
</div>
</div>
<div class="cell" data-hash="Disney-ML-Process_cache/html/confusion_matrix_b17a1238e2eef112e0566ab357397487">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>review_final <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(polar, .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Negative Positive
  Negative      197       54
  Positive      139     5772</code></pre>
</div>
</div>
<p>As you can see it did a pretty good job on 5* ratings but not quite so well on 1* ratings. Maybe this is a consequence of how the ratings are distributed in the data? Maybe positive sentiments are more explicitly expressed?</p>
<div class="cell" data-hash="Disney-ML-Process_cache/html/print_elapsed_64e380c18f19f86f5a9b78cae5c628fa">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "This sheet took  110  minutes and  5.63 seconds to run."</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>